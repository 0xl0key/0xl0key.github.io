<!DOCTYPE html>
<html lang="en-us" data-theme="light">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>
  Hackropole : PORS - l0key blog
</title>



<meta name="description" content="This writeup is for the PORS challenge from Hackropole, a 2-star difficulty challenge.
Reconnaissance
The binary is in ELF format, x86_64 architecture and is …" />



<meta
  property="og:title"
  content="Hackropole : PORS"
/>
<meta
  property="og:description"
  content="This writeup is for the PORS challenge from Hackropole, a 2-star difficulty challenge.
Reconnaissance
The binary is in ELF format, x86_64 architecture and is …"
/>
<meta
  property="og:type"
  content="article"
/>
<meta property="og:url" content="http://localhost:1313/posts/pors/hackropole_pors/" />
<meta property="og:site_name" content="l0key blog" />


<meta name="twitter:card" content="summary_large_image" />
<meta
  name="twitter:title"
  content="Hackropole : PORS"
/>
<meta
  name="twitter:description"
  content="This writeup is for the PORS challenge from Hackropole, a 2-star difficulty challenge.
Reconnaissance
The binary is in ELF format, x86_64 architecture and is …"
/>


<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link
  href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;700&family=JetBrains+Mono:wght@400;500&display=swap"
  rel="stylesheet"
/>


<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
/>


<link rel="stylesheet" href="http://localhost:1313/css/style.css">
<link rel="stylesheet" href="/css/custom.css">
<script src="/js/image-zoom.js"></script>



</head>
<body>
    
    <div class="reading-progress"></div>
    

    

    <main>
        

<div class="post-overlay active">
    <div class="post-overlay-backdrop"></div>
    <div class="post-overlay-content" style="position: relative; min-height: 100vh; padding: 0; transform: translateY(0);">
        <div class="post-overlay-header">
            <div class="post-overlay-title">
                <a href="/" class="overlay-site-title">l0key blog</a>
            </div>
            <button class="post-overlay-close" aria-label="Close post" onclick="window.location.href='/'">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="post-layout">
        <article class="post-content">
            <header class="post-header">
                <div class="post-meta">
                    <span class="post-date">2025.10.12</span>
                    <div class="reading-time-post">
                        <span class="coffee-cups">
                            
                            
                            
                            
                                
                            
                            
                                
                            
                                
                            
                                
                            
                                
                            
                                
                            
                            ☕☕☕☕☕
                        </span>
                        <span>11 min read</span>
                    </div>
                </div>
                <h1 class="post-title">Hackropole : PORS</h1>
                

                
                <div class="post-tags-header">
                    
                    <a href="http://localhost:1313/tags/reverse" class="post-tag">reverse</a>
                    
                </div>
                
            </header>
            <div class="post-body">
                <p>This writeup is for the PORS challenge from Hackropole, a 2-star difficulty challenge.</p>
<h2 id="reconnaissance">Reconnaissance</h2>
<p>The binary is in ELF format, x86_64 architecture and is stripped:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>l0key at dev in <span style="color:#f92672">[</span>~/Documents/hackropole/pors<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>19:39:09 › file pors
</span></span><span style="display:flex;"><span>pors: ELF 64-bit LSB executable, x86-64, version <span style="color:#ae81ff">1</span> <span style="color:#f92672">(</span>SYSV<span style="color:#f92672">)</span>, dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID<span style="color:#f92672">[</span>sha1<span style="color:#f92672">]=</span>e03394fc3f442e87fd6114acbff6082426e4a652, <span style="color:#66d9ef">for</span> GNU/Linux 3.2.0, stripped
</span></span></code></pre></div><p>A first execution shows that it asks for input:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>l0key at dev in <span style="color:#f92672">[</span>~/Documents/hackropole/pors<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>19:39:12 › ./pors
</span></span><span style="display:flex;"><span>Enter your input: test
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> Wrong input, sorry...
</span></span></code></pre></div><p>There&rsquo;s also a file containing raw data alongside the executable (program.bin).</p>
<h3 id="initial-analysis-with-ghidra">Initial Analysis with Ghidra</h3>
<p>We decompile the PORS program with Ghidra to find the steps that validate our input. Ghidra gives us this C pseudo-code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  uint buf_2;
</span></span><span style="display:flex;"><span>  uint buf_one;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>p3;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>p2;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>p1;
</span></span><span style="display:flex;"><span>  FILE <span style="color:#f92672">*</span>fdesc;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  fdesc <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen</span>(<span style="color:#e6db74">&#34;program.bin&#34;</span>,<span style="color:#e6db74">&#34;r&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (fdesc <span style="color:#f92672">==</span> (FILE <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;[-] Failed to load program :/&#34;</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* WARNING: Subroutine does not return */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fread</span>(<span style="color:#f92672">&amp;</span>buf_one,<span style="color:#ae81ff">4</span>,<span style="color:#ae81ff">1</span>,fdesc);
</span></span><span style="display:flex;"><span>  p1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mmap</span>((<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x13370000</span>,(<span style="color:#66d9ef">long</span>)(<span style="color:#66d9ef">int</span>)((buf_one <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xfffff000</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1000</span>),<span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">0x22</span>,<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (p1 <span style="color:#f92672">!=</span> (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x13370000</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;[-] init failed, sorry :/&#34;</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* WARNING: Subroutine does not return */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fread</span>((<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x13370000</span>,<span style="color:#ae81ff">1</span>,(<span style="color:#66d9ef">long</span>)(<span style="color:#66d9ef">int</span>)buf_one,fdesc);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fread</span>(<span style="color:#f92672">&amp;</span>buf_2,<span style="color:#ae81ff">4</span>,<span style="color:#ae81ff">1</span>,fdesc);
</span></span><span style="display:flex;"><span>  p2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mmap</span>((<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x42420000</span>,(<span style="color:#66d9ef">long</span>)(<span style="color:#66d9ef">int</span>)((buf_2 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xfffff000</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1000</span>),<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">0x22</span>,<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (p2 <span style="color:#f92672">!=</span> (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x42420000</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;[-] init failed, sorry :/&#34;</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* WARNING: Subroutine does not return */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fread</span>((<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x42420000</span>,<span style="color:#ae81ff">1</span>,(<span style="color:#66d9ef">long</span>)(<span style="color:#66d9ef">int</span>)buf_2,fdesc);
</span></span><span style="display:flex;"><span>  p3 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mmap</span>((<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0xcafe0000</span>,<span style="color:#ae81ff">0x2000</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">0x22</span>,<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (p3 <span style="color:#f92672">!=</span> (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0xcafe0000</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;[-] init failed, sorry :/&#34;</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* WARNING: Subroutine does not return */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">syscall</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Without going too far, we can already see there&rsquo;s an issue. Indeed, we don&rsquo;t see anywhere a part that retrieves and validates our input.</p>
<p>However, we can observe that the program.bin file is read and stored in memory regions of our process.</p>
<p>The way it&rsquo;s read should catch our attention. We can see that the data is divided into 3 specific memory regions (0x13370000, 0x42420000 and 0xcafe0000) and that mmap gives precise permissions to these memory regions. More specifically, the first mmap gives RWX permissions to the memory region starting at 0x13370000. Moreover, we can see that the file is parsed in a precise manner: we first read 4 bytes at the beginning of the file which are used in the size parameter of mmap, then we use these 4 bytes again to read a certain number of bytes into the allocated memory region. This means that each section in the program.bin file starts with information about its size.</p>
<p>All of this indicates that the rest of the program&rsquo;s logic is in program.bin.</p>
<p>Finally, we can see that we have a syscall at the end of main. Looking at the assembly code more closely, we can get more information:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">MOV</span>        <span style="color:#66d9ef">RSP</span>,<span style="color:#ae81ff">0x42420000</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">MOV</span>        <span style="color:#66d9ef">RAX</span>,<span style="color:#ae81ff">0xf</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">SYSCALL</span>
</span></span></code></pre></div><p>RSP now contains the address 0x42420000 and the syscall number is 0xf, which corresponds to the syscall: rt_sigreturn.</p>
<p>Searching a bit on the internet and with the help of the challenge title, we come across an exploitation technique called SROP.</p>
<p>This technique abuses signal handling under Linux/Unix.</p>
<h2 id="description-of-srop">Description of SROP</h2>
<p>First, we need to understand how signal handling works under Linux.</p>
<p>When a process receives a signal (SIGSEGV, SIGINT&hellip;), it proceeds as follows:</p>
<ol>
<li>The kernel saves the context, i.e., all registers and flags.</li>
<li>A signal handler executes.</li>
<li>Return to the program via the sigreturn syscall (syscall 15) which restores all registers from the stack.</li>
</ol>
<p>SROP abuses this system by forging a fake signal frame representing the context and then calling the sigreturn syscall. Thus, the program resumes with the fake frame, with register values that we control.</p>
<p>The fake signal frame looks like this:
![[frame.png]]</p>
<h2 id="extracting-the-real-program">Extracting the Real Program</h2>
<p>Our program here uses the SROP technique to execute the real program, which verifies our input.</p>
<p>Here, the memory region starting at 0x13370000 contains the code that will be executed, the memory region 0x42420000 contains the fake stack frame, and 0xcafe0000 is likely used as a memory region for the SROP program.</p>
<p>To understand what our program really does, I wrote a C program to extract from program.bin the code present at 0x13370000, using the same principle as the pors program to parse it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;inttypes.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;capstone/capstone.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">get_code_section</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> buf[], <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> buf_size)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  csh handle;
</span></span><span style="display:flex;"><span>  cs_insn <span style="color:#f92672">*</span>insn;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">size_t</span> count;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">cs_open</span>(CS_ARCH_X86, CS_MODE_64, <span style="color:#f92672">&amp;</span>handle) <span style="color:#f92672">!=</span> CS_ERR_OK) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> EXIT_FAILURE;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  count <span style="color:#f92672">=</span> <span style="color:#a6e22e">cs_disasm</span>(handle, buf, buf_size<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0x13370000</span>, <span style="color:#ae81ff">0</span>, <span style="color:#f92672">&amp;</span>insn);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (count <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">size_t</span> i;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> count; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;0x%&#34;</span>PRIx64<span style="color:#e6db74">&#34;:</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">%s</span><span style="color:#ae81ff">\t\t</span><span style="color:#e6db74">%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, insn[i].address, insn[i].mnemonic,
</span></span><span style="display:flex;"><span>             insn[i].op_str);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Error: Failed to disassemble given code!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> EXIT_FAILURE;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> EXIT_SUCCESS;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  FILE<span style="color:#f92672">*</span> file;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">uint32_t</span> size;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  file <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen</span>(<span style="color:#e6db74">&#34;program.bin&#34;</span>, <span style="color:#e6db74">&#34;rb&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>file) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Erreur ouverture fichier</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fread</span>(<span style="color:#f92672">&amp;</span>size, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">1</span>, file);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>buf <span style="color:#f92672">=</span> <span style="color:#a6e22e">malloc</span>(size);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fread</span>(buf, <span style="color:#ae81ff">1</span> , size, file);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%d&#34;</span>, size);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">get_code_section</span>(buf, size)) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Error disassembling code section !</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fclose</span>(file);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">free</span>(buf);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> EXIT_SUCCESS;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This displays several blocks separated by garbage code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0</span>x13370000:	<span style="color:#a6e22e">mov</span>		<span style="color:#66d9ef">rax</span>, <span style="color:#66d9ef">rdx</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0</span>x13370003:	<span style="color:#a6e22e">add</span>		<span style="color:#66d9ef">rax</span>, <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0</span>x13370007:	<span style="color:#a6e22e">imul</span>		<span style="color:#66d9ef">rax</span>, <span style="color:#66d9ef">rax</span>, <span style="color:#ae81ff">0xf8</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0</span>x1337000e:	<span style="color:#a6e22e">add</span>		<span style="color:#66d9ef">rsp</span>, <span style="color:#66d9ef">rax</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0</span>x13370011:	<span style="color:#a6e22e">mov</span>		<span style="color:#66d9ef">rax</span>, <span style="color:#ae81ff">0xf</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0</span>x13370018:	<span style="color:#a6e22e">syscall</span>		
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">...</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0</span>x13370050:	<span style="color:#a6e22e">syscall</span>		
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x13370052</span>:	<span style="color:#66d9ef">mov</span>		<span style="color:#66d9ef">rsp</span>, <span style="color:#ae81ff">0x42420000</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0</span>x13370059:	<span style="color:#a6e22e">mov</span>		<span style="color:#66d9ef">qword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">rsp</span> <span style="color:#960050;background-color:#1e0010">+</span> <span style="color:#ae81ff">0x88</span>], <span style="color:#ae81ff">0x40</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0</span>x13370065:	<span style="color:#a6e22e">mov</span>		<span style="color:#66d9ef">rax</span>, <span style="color:#ae81ff">0xf</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0</span>x1337006c:	<span style="color:#a6e22e">syscall</span>		
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">...</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0</span>x133700a0:	<span style="color:#a6e22e">cmp</span>		<span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">rsp</span> <span style="color:#960050;background-color:#1e0010">+</span> <span style="color:#ae81ff">8</span>], <span style="color:#66d9ef">eax</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0</span>x133700a4:	<span style="color:#a6e22e">mov</span>		<span style="color:#66d9ef">rsp</span>, <span style="color:#ae81ff">0x42420000</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0</span>x133700ab:	<span style="color:#a6e22e">mov</span>		<span style="color:#66d9ef">rax</span>, <span style="color:#ae81ff">0x2d</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0</span>x133700b2:	<span style="color:#a6e22e">mov</span>		<span style="color:#66d9ef">rbx</span>, <span style="color:#ae81ff">0x21</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0</span>x133700b9:	<span style="color:#a6e22e">cmovl</span>		<span style="color:#66d9ef">rax</span>, <span style="color:#66d9ef">rbx</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0</span>x133700bd:	<span style="color:#a6e22e">mov</span>		<span style="color:#66d9ef">qword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">rsp</span> <span style="color:#960050;background-color:#1e0010">+</span> <span style="color:#ae81ff">0x88</span>], <span style="color:#66d9ef">rax</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0</span>x133700c5:	<span style="color:#a6e22e">mov</span>		<span style="color:#66d9ef">rax</span>, <span style="color:#ae81ff">0xf</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0</span>x133700cc:	<span style="color:#a6e22e">syscall</span>		
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">etc</span>
</span></span></code></pre></div><p>Looking at the structure more closely, we can see that the program using SROP adds a layer of obfuscation, specifically Control Flow Flattening (CFF). Indeed, we can see that RSP is always filled with the address 0x42420000 and that the sigreturn syscall is called at the end of each block, which means that each block returns to the first block which handles dispatching to the next block. This is how CFF works. We can verify this with gdb:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">$rax</span>   : <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$rbx</span>   : <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$rcx</span>   : <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$rdx</span>   : <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$rsp</span>   : <span style="color:#ae81ff">0x0000000042420000</span>  <span style="color:#960050;background-color:#1e0010">→</span>  <span style="color:#ae81ff">0x0000000000000000</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$rbp</span>   : <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$rsi</span>   : <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$rdi</span>   : <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$rip</span>   : <span style="color:#ae81ff">0x0000000013370000</span>  <span style="color:#960050;background-color:#1e0010">→</span>  <span style="color:#ae81ff">0x4801c08348d08948</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$r8</span>    : <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$r9</span>    : <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$r10</span>   : <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$r11</span>   : <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$r12</span>   : <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$r13</span>   : <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$r14</span>   : <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$r15</span>   : <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>$eflags: <span style="color:#960050;background-color:#1e0010">[</span><span style="color:#a6e22e">zero</span> <span style="color:#66d9ef">carry</span> <span style="color:#66d9ef">parity</span> <span style="color:#66d9ef">adjust</span> <span style="color:#66d9ef">sign</span> <span style="color:#66d9ef">trap</span> <span style="color:#66d9ef">INTERRUPT</span> <span style="color:#66d9ef">direction</span> <span style="color:#66d9ef">overflow</span> <span style="color:#66d9ef">resume</span> <span style="color:#66d9ef">virtualx86</span> <span style="color:#66d9ef">identification</span>]
</span></span><span style="display:flex;"><span>$cs: <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x33</span> <span style="color:#66d9ef">$ss</span>: <span style="color:#ae81ff">0x2b</span> <span style="color:#66d9ef">$ds</span>: <span style="color:#ae81ff">0x00</span> <span style="color:#66d9ef">$es</span>: <span style="color:#ae81ff">0x00</span> <span style="color:#66d9ef">$fs</span>: <span style="color:#ae81ff">0x00</span> <span style="color:#66d9ef">$gs</span>: <span style="color:#ae81ff">0x00</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span> <span style="color:#a6e22e">stack</span> <span style="color:#960050;background-color:#1e0010">────</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x0000000042420000</span><span style="color:#960050;background-color:#1e0010">│+</span><span style="color:#ae81ff">0x0000</span>: <span style="color:#ae81ff">0x0000000000000000</span>	 <span style="color:#960050;background-color:#1e0010">←</span> <span style="color:#66d9ef">$rsp</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x0000000042420008</span><span style="color:#960050;background-color:#1e0010">│+</span><span style="color:#ae81ff">0x0008</span>: <span style="color:#ae81ff">0x0000000000000000</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x0000000042420010</span><span style="color:#960050;background-color:#1e0010">│+</span><span style="color:#ae81ff">0x0010</span>: <span style="color:#ae81ff">0x0000000000000000</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x0000000042420018</span><span style="color:#960050;background-color:#1e0010">│+</span><span style="color:#ae81ff">0x0018</span>: <span style="color:#ae81ff">0x0000000000000000</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x0000000042420020</span><span style="color:#960050;background-color:#1e0010">│+</span><span style="color:#ae81ff">0x0020</span>: <span style="color:#ae81ff">0x0000000000000000</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x0000000042420028</span><span style="color:#960050;background-color:#1e0010">│+</span><span style="color:#ae81ff">0x0028</span>: <span style="color:#ae81ff">0x0000000000000000</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x0000000042420030</span><span style="color:#960050;background-color:#1e0010">│+</span><span style="color:#ae81ff">0x0030</span>: <span style="color:#ae81ff">0x0000000000000000</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x0000000042420038</span><span style="color:#960050;background-color:#1e0010">│+</span><span style="color:#ae81ff">0x0038</span>: <span style="color:#ae81ff">0x0000000000000000</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span> code:x86:<span style="color:#960050;background-color:#1e0010">64</span> <span style="color:#960050;background-color:#1e0010">────</span>
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">→</span> <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x13370000</span>                  <span style="color:#66d9ef">mov</span>    <span style="color:#66d9ef">rax</span>, <span style="color:#66d9ef">rdx</span>
</span></span><span style="display:flex;"><span>   <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x13370003</span>                  <span style="color:#66d9ef">add</span>    <span style="color:#66d9ef">rax</span>, <span style="color:#ae81ff">0x1</span>
</span></span><span style="display:flex;"><span>   <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x13370007</span>                  <span style="color:#66d9ef">imul</span>   <span style="color:#66d9ef">rax</span>, <span style="color:#66d9ef">rax</span>, <span style="color:#ae81ff">0xf8</span>
</span></span><span style="display:flex;"><span>   <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x1337000e</span>                  <span style="color:#66d9ef">add</span>    <span style="color:#66d9ef">rsp</span>, <span style="color:#66d9ef">rax</span>
</span></span><span style="display:flex;"><span>   <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x13370011</span>                  <span style="color:#66d9ef">mov</span>    <span style="color:#66d9ef">rax</span>, <span style="color:#ae81ff">0xf</span>
</span></span><span style="display:flex;"><span>   <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x13370018</span>                  <span style="color:#66d9ef">syscall</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span> <span style="color:#a6e22e">threads</span> <span style="color:#960050;background-color:#1e0010">────</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">[</span><span style="color:#75715e">#0] Id 1, Name: &#34;pors&#34;, stopped 0x13370000 in ?? (), reason: SINGLE STEP
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span> <span style="color:#a6e22e">trace</span> <span style="color:#960050;background-color:#1e0010">────</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">[</span><span style="color:#75715e">#0] 0x13370000 → mov rax, rdx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">gef</span><span style="color:#960050;background-color:#1e0010">➤</span>
</span></span></code></pre></div><p>Here, I set a breakpoint right after the first syscall in the pors program. We can see that for rsp 0x42420000, the recovered stack frame has an rip register pointing to the code at 0x13370000. This block is therefore the dispatcher.</p>
<p>Looking more closely at the dispatcher block, we can see that it uses the rax register to calculate the address of the next fake frame, and that in some blocks we have conditional mov instructions, which will either set rax with the value of rbx or keep the base value of rax, which looks like an if/else structure.</p>
<h2 id="deobfuscate">Deobfuscate</h2>
<p>To deobfuscate this program, we need to emulate the dispatcher in order to replace the syscalls in each block with simple jmp instructions.</p>
<p>For this, I wrote a Python script to obtain the real program stored in program.bin:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> capstone <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>FRAME_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xf8</span>
</span></span><span style="display:flex;"><span>CODE_START_ADDR <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x13370000</span>
</span></span><span style="display:flex;"><span>CODE_BLOCK_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x50</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cmov_to_jmp <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;cmovne&#39;</span>: <span style="color:#e6db74">&#39;jne&#39;</span>,   
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;cmove&#39;</span>:  <span style="color:#e6db74">&#39;je&#39;</span>,    
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;cmovg&#39;</span>:  <span style="color:#e6db74">&#39;jg&#39;</span>,     
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;cmovl&#39;</span>:  <span style="color:#e6db74">&#39;jl&#39;</span>,     
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;cmovle&#39;</span>: <span style="color:#e6db74">&#39;jle&#39;</span>,    
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;cmovge&#39;</span>: <span style="color:#e6db74">&#39;jge&#39;</span>,   
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;cmova&#39;</span>:  <span style="color:#e6db74">&#39;ja&#39;</span>,     
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;cmovb&#39;</span>:  <span style="color:#e6db74">&#39;jb&#39;</span>,     
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;cmovae&#39;</span>: <span style="color:#e6db74">&#39;jae&#39;</span>,    
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;cmovbe&#39;</span>: <span style="color:#e6db74">&#39;jbe&#39;</span>,    
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;cmovs&#39;</span>:  <span style="color:#e6db74">&#39;js&#39;</span>,    
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;cmovns&#39;</span>: <span style="color:#e6db74">&#39;jns&#39;</span>,    
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;cmovo&#39;</span>:  <span style="color:#e6db74">&#39;jo&#39;</span>,     
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;cmovno&#39;</span>: <span style="color:#e6db74">&#39;jno&#39;</span>,    
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;cmovc&#39;</span>:  <span style="color:#e6db74">&#39;jc&#39;</span>,     
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;cmovnc&#39;</span>: <span style="color:#e6db74">&#39;jnc&#39;</span>,    
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;cmovz&#39;</span>:  <span style="color:#e6db74">&#39;jz&#39;</span>,     
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;cmovnz&#39;</span>: <span style="color:#e6db74">&#39;jnz&#39;</span>,    
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;cmovp&#39;</span>:  <span style="color:#e6db74">&#39;jp&#39;</span>,    
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;cmovnp&#39;</span>: <span style="color:#e6db74">&#39;jnp&#39;</span>, 
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>md <span style="color:#f92672">=</span> Cs(CS_ARCH_X86, CS_MODE_64)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Reading sections</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#39;program.bin&#39;</span>, <span style="color:#e6db74">&#39;rb&#39;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>    code_section_size <span style="color:#f92672">=</span> int<span style="color:#f92672">.</span>from_bytes(f<span style="color:#f92672">.</span>read(<span style="color:#ae81ff">4</span>), <span style="color:#e6db74">&#39;little&#39;</span>)
</span></span><span style="display:flex;"><span>    code_section <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>read(code_section_size)
</span></span><span style="display:flex;"><span>    frame_section_size <span style="color:#f92672">=</span> int<span style="color:#f92672">.</span>from_bytes(f<span style="color:#f92672">.</span>read(<span style="color:#ae81ff">4</span>), <span style="color:#e6db74">&#39;little&#39;</span>)
</span></span><span style="display:flex;"><span>    frame_section <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>read(frame_section_size)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>nb_frames <span style="color:#f92672">=</span> frame_section_size <span style="color:#f92672">//</span> FRAME_SIZE
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>frames_list <span style="color:#f92672">=</span> [SigreturnFrame(arch<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;amd64&#39;</span>) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(nb_frames)]
</span></span><span style="display:flex;"><span>couple_frame_code <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(nb_frames):
</span></span><span style="display:flex;"><span>    offset <span style="color:#f92672">=</span> i<span style="color:#f92672">*</span>FRAME_SIZE
</span></span><span style="display:flex;"><span>    frames_list[i]<span style="color:#f92672">.</span>r8 <span style="color:#f92672">=</span> int<span style="color:#f92672">.</span>from_bytes(frame_section[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0x28</span> : offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0x30</span>], <span style="color:#e6db74">&#39;little&#39;</span>)
</span></span><span style="display:flex;"><span>    frames_list[i]<span style="color:#f92672">.</span>r9 <span style="color:#f92672">=</span> int<span style="color:#f92672">.</span>from_bytes(frame_section[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0x30</span> : offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0x38</span>], <span style="color:#e6db74">&#39;little&#39;</span>)
</span></span><span style="display:flex;"><span>    frames_list[i]<span style="color:#f92672">.</span>r10 <span style="color:#f92672">=</span> int<span style="color:#f92672">.</span>from_bytes(frame_section[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0x38</span> : offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0x40</span>], <span style="color:#e6db74">&#39;little&#39;</span>)
</span></span><span style="display:flex;"><span>    frames_list[i]<span style="color:#f92672">.</span>r11 <span style="color:#f92672">=</span> int<span style="color:#f92672">.</span>from_bytes(frame_section[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0x40</span> : offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0x48</span>], <span style="color:#e6db74">&#39;little&#39;</span>)
</span></span><span style="display:flex;"><span>    frames_list[i]<span style="color:#f92672">.</span>r12 <span style="color:#f92672">=</span> int<span style="color:#f92672">.</span>from_bytes(frame_section[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0x48</span> : offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0x50</span>], <span style="color:#e6db74">&#39;little&#39;</span>)
</span></span><span style="display:flex;"><span>    frames_list[i]<span style="color:#f92672">.</span>r13 <span style="color:#f92672">=</span> int<span style="color:#f92672">.</span>from_bytes(frame_section[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0x50</span> : offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0x58</span>], <span style="color:#e6db74">&#39;little&#39;</span>)
</span></span><span style="display:flex;"><span>    frames_list[i]<span style="color:#f92672">.</span>r14 <span style="color:#f92672">=</span> int<span style="color:#f92672">.</span>from_bytes(frame_section[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0x58</span> : offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0x60</span>], <span style="color:#e6db74">&#39;little&#39;</span>)
</span></span><span style="display:flex;"><span>    frames_list[i]<span style="color:#f92672">.</span>r15 <span style="color:#f92672">=</span> int<span style="color:#f92672">.</span>from_bytes(frame_section[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0x60</span> : offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0x68</span>], <span style="color:#e6db74">&#39;little&#39;</span>)
</span></span><span style="display:flex;"><span>    frames_list[i]<span style="color:#f92672">.</span>rdi <span style="color:#f92672">=</span> int<span style="color:#f92672">.</span>from_bytes(frame_section[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0x68</span> : offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0x70</span>], <span style="color:#e6db74">&#39;little&#39;</span>)
</span></span><span style="display:flex;"><span>    frames_list[i]<span style="color:#f92672">.</span>rsi <span style="color:#f92672">=</span> int<span style="color:#f92672">.</span>from_bytes(frame_section[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0x70</span> : offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0x78</span>], <span style="color:#e6db74">&#39;little&#39;</span>)
</span></span><span style="display:flex;"><span>    frames_list[i]<span style="color:#f92672">.</span>rbp <span style="color:#f92672">=</span> int<span style="color:#f92672">.</span>from_bytes(frame_section[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0x78</span> : offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0x80</span>], <span style="color:#e6db74">&#39;little&#39;</span>)
</span></span><span style="display:flex;"><span>    frames_list[i]<span style="color:#f92672">.</span>rbx <span style="color:#f92672">=</span> int<span style="color:#f92672">.</span>from_bytes(frame_section[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0x80</span> : offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0x88</span>], <span style="color:#e6db74">&#39;little&#39;</span>)
</span></span><span style="display:flex;"><span>    frames_list[i]<span style="color:#f92672">.</span>rdx <span style="color:#f92672">=</span> int<span style="color:#f92672">.</span>from_bytes(frame_section[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0x88</span> : offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0x90</span>], <span style="color:#e6db74">&#39;little&#39;</span>)
</span></span><span style="display:flex;"><span>    frames_list[i]<span style="color:#f92672">.</span>rax <span style="color:#f92672">=</span> int<span style="color:#f92672">.</span>from_bytes(frame_section[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0x90</span> : offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0x98</span>], <span style="color:#e6db74">&#39;little&#39;</span>)
</span></span><span style="display:flex;"><span>    frames_list[i]<span style="color:#f92672">.</span>rcx <span style="color:#f92672">=</span> int<span style="color:#f92672">.</span>from_bytes(frame_section[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0x98</span> : offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0xa0</span>], <span style="color:#e6db74">&#39;little&#39;</span>)
</span></span><span style="display:flex;"><span>    frames_list[i]<span style="color:#f92672">.</span>rsp <span style="color:#f92672">=</span> int<span style="color:#f92672">.</span>from_bytes(frame_section[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0xa0</span> : offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0xa8</span>], <span style="color:#e6db74">&#39;little&#39;</span>)
</span></span><span style="display:flex;"><span>    frames_list[i]<span style="color:#f92672">.</span>rip <span style="color:#f92672">=</span> int<span style="color:#f92672">.</span>from_bytes(frame_section[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0xa8</span> : offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0xb0</span>], <span style="color:#e6db74">&#39;little&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Create tuple(indice_code_block, indice_srop_frame)</span>
</span></span><span style="display:flex;"><span>    frame_code <span style="color:#f92672">=</span> (((frames_list[i]<span style="color:#f92672">.</span>rip <span style="color:#f92672">-</span> CODE_START_ADDR) <span style="color:#f92672">//</span> CODE_BLOCK_SIZE), i)
</span></span><span style="display:flex;"><span>    couple_frame_code<span style="color:#f92672">.</span>append(frame_code)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>code_block <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> el <span style="color:#f92672">in</span> couple_frame_code:
</span></span><span style="display:flex;"><span>    offset <span style="color:#f92672">=</span> el[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">*</span> CODE_BLOCK_SIZE
</span></span><span style="display:flex;"><span>    code_block <span style="color:#f92672">=</span> code_section[offset : offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0x50</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    load_frame <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;mov r8, </span><span style="color:#e6db74">{</span>frames_list[el[<span style="color:#ae81ff">1</span>]]<span style="color:#f92672">.</span>r8<span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    load_frame <span style="color:#f92672">=</span> load_frame <span style="color:#f92672">+</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;mov r9, 0x</span><span style="color:#e6db74">{</span>frames_list[el[<span style="color:#ae81ff">1</span>]]<span style="color:#f92672">.</span>r9<span style="color:#e6db74">:</span><span style="color:#e6db74">x</span><span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    load_frame <span style="color:#f92672">=</span> load_frame <span style="color:#f92672">+</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;mov r10, 0x</span><span style="color:#e6db74">{</span>frames_list[el[<span style="color:#ae81ff">1</span>]]<span style="color:#f92672">.</span>r10<span style="color:#e6db74">:</span><span style="color:#e6db74">x</span><span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    load_frame <span style="color:#f92672">=</span> load_frame <span style="color:#f92672">+</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;mov r11, 0x</span><span style="color:#e6db74">{</span>frames_list[el[<span style="color:#ae81ff">1</span>]]<span style="color:#f92672">.</span>r11<span style="color:#e6db74">:</span><span style="color:#e6db74">x</span><span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    load_frame <span style="color:#f92672">=</span> load_frame <span style="color:#f92672">+</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;mov r12, 0x</span><span style="color:#e6db74">{</span>frames_list[el[<span style="color:#ae81ff">1</span>]]<span style="color:#f92672">.</span>r12<span style="color:#e6db74">:</span><span style="color:#e6db74">x</span><span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    load_frame <span style="color:#f92672">=</span> load_frame <span style="color:#f92672">+</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;mov r13, 0x</span><span style="color:#e6db74">{</span>frames_list[el[<span style="color:#ae81ff">1</span>]]<span style="color:#f92672">.</span>r13<span style="color:#e6db74">:</span><span style="color:#e6db74">x</span><span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    load_frame <span style="color:#f92672">=</span> load_frame <span style="color:#f92672">+</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;mov r14, 0x</span><span style="color:#e6db74">{</span>frames_list[el[<span style="color:#ae81ff">1</span>]]<span style="color:#f92672">.</span>r14<span style="color:#e6db74">:</span><span style="color:#e6db74">x</span><span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    load_frame <span style="color:#f92672">=</span> load_frame <span style="color:#f92672">+</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;mov r15, 0x</span><span style="color:#e6db74">{</span>frames_list[el[<span style="color:#ae81ff">1</span>]]<span style="color:#f92672">.</span>r15<span style="color:#e6db74">:</span><span style="color:#e6db74">x</span><span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    load_frame <span style="color:#f92672">=</span> load_frame <span style="color:#f92672">+</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;mov rdi, 0x</span><span style="color:#e6db74">{</span>frames_list[el[<span style="color:#ae81ff">1</span>]]<span style="color:#f92672">.</span>rdi<span style="color:#e6db74">:</span><span style="color:#e6db74">x</span><span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    load_frame <span style="color:#f92672">=</span> load_frame <span style="color:#f92672">+</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;mov rsi, 0x</span><span style="color:#e6db74">{</span>frames_list[el[<span style="color:#ae81ff">1</span>]]<span style="color:#f92672">.</span>rsi<span style="color:#e6db74">:</span><span style="color:#e6db74">x</span><span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    load_frame <span style="color:#f92672">=</span> load_frame <span style="color:#f92672">+</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;mov rbp, 0x</span><span style="color:#e6db74">{</span>frames_list[el[<span style="color:#ae81ff">1</span>]]<span style="color:#f92672">.</span>rbp<span style="color:#e6db74">:</span><span style="color:#e6db74">x</span><span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    load_frame <span style="color:#f92672">=</span> load_frame <span style="color:#f92672">+</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;mov rbx, 0x</span><span style="color:#e6db74">{</span>frames_list[el[<span style="color:#ae81ff">1</span>]]<span style="color:#f92672">.</span>rbx<span style="color:#e6db74">:</span><span style="color:#e6db74">x</span><span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    load_frame <span style="color:#f92672">=</span> load_frame <span style="color:#f92672">+</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;mov rdx, 0x</span><span style="color:#e6db74">{</span>frames_list[el[<span style="color:#ae81ff">1</span>]]<span style="color:#f92672">.</span>rdx<span style="color:#e6db74">:</span><span style="color:#e6db74">x</span><span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    load_frame <span style="color:#f92672">=</span> load_frame <span style="color:#f92672">+</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;mov rax, 0x</span><span style="color:#e6db74">{</span>frames_list[el[<span style="color:#ae81ff">1</span>]]<span style="color:#f92672">.</span>rax<span style="color:#e6db74">:</span><span style="color:#e6db74">x</span><span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    load_frame <span style="color:#f92672">=</span> load_frame <span style="color:#f92672">+</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;mov rcx, 0x</span><span style="color:#e6db74">{</span>frames_list[el[<span style="color:#ae81ff">1</span>]]<span style="color:#f92672">.</span>rcx<span style="color:#e6db74">:</span><span style="color:#e6db74">x</span><span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    load_frame <span style="color:#f92672">=</span> load_frame <span style="color:#f92672">+</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;mov rsp, 0x</span><span style="color:#e6db74">{</span>frames_list[el[<span style="color:#ae81ff">1</span>]]<span style="color:#f92672">.</span>rsp<span style="color:#e6db74">:</span><span style="color:#e6db74">x</span><span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(load_frame)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    find_mov <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>    find_imm_rsp <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>    rax_imm <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    rbx_imm <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    rsp_imm <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> md<span style="color:#f92672">.</span>disasm(code_block, <span style="color:#ae81ff">0x13370000</span> <span style="color:#f92672">+</span> offset):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> el[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> i<span style="color:#f92672">.</span>mnemonic <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;add&#34;</span> <span style="color:#f92672">and</span> i<span style="color:#f92672">.</span>op_str <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;byte ptr [rax], al&#34;</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;mov&#34;</span> <span style="color:#f92672">in</span> i<span style="color:#f92672">.</span>mnemonic <span style="color:#f92672">and</span> <span style="color:#e6db74">&#34;rax&#34;</span> <span style="color:#f92672">in</span> i<span style="color:#f92672">.</span>op_str <span style="color:#f92672">and</span> <span style="color:#e6db74">&#34;0x&#34;</span> <span style="color:#f92672">in</span> i<span style="color:#f92672">.</span>op_str:
</span></span><span style="display:flex;"><span>                find_mov <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>                rax_imm <span style="color:#f92672">=</span> int(i<span style="color:#f92672">.</span>op_str<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;, &#34;</span>)[<span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;mov&#34;</span> <span style="color:#f92672">in</span> i<span style="color:#f92672">.</span>mnemonic <span style="color:#f92672">and</span> <span style="color:#e6db74">&#34;rbx&#34;</span> <span style="color:#f92672">in</span> i<span style="color:#f92672">.</span>op_str <span style="color:#f92672">and</span> <span style="color:#e6db74">&#34;0x&#34;</span> <span style="color:#f92672">in</span> i<span style="color:#f92672">.</span>op_str:
</span></span><span style="display:flex;"><span>                rbx_imm <span style="color:#f92672">=</span> int(i<span style="color:#f92672">.</span>op_str<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;, &#34;</span>)[<span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;mov&#34;</span> <span style="color:#f92672">in</span> i<span style="color:#f92672">.</span>mnemonic <span style="color:#f92672">and</span> <span style="color:#e6db74">&#34;qword ptr [rsp + 0x88]&#34;</span> <span style="color:#f92672">in</span> i<span style="color:#f92672">.</span>op_str <span style="color:#f92672">and</span> <span style="color:#e6db74">&#34;rax&#34;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> i<span style="color:#f92672">.</span>op_str:
</span></span><span style="display:flex;"><span>                find_imm_rsp <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>                rsp_imm <span style="color:#f92672">=</span> int(i<span style="color:#f92672">.</span>op_str<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;, &#34;</span>)[<span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> find_mov:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;cmov&#34;</span> <span style="color:#f92672">in</span> i<span style="color:#f92672">.</span>mnemonic:
</span></span><span style="display:flex;"><span>                    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>cmov_to_jmp[i<span style="color:#f92672">.</span>mnemonic]<span style="color:#e6db74">}</span><span style="color:#e6db74"> cond&#34;</span>)
</span></span><span style="display:flex;"><span>                    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;jmp </span><span style="color:#e6db74">{</span>frames_list[rax_imm <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>rip<span style="color:#e6db74">:</span><span style="color:#e6db74">x</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>                    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;cond:&#34;</span>)
</span></span><span style="display:flex;"><span>                    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;jmp </span><span style="color:#e6db74">{</span>frames_list[rbx_imm <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>rip<span style="color:#e6db74">:</span><span style="color:#e6db74">x</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> find_imm_rsp:
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;jmp </span><span style="color:#e6db74">{</span>frames_list[rsp_imm <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>rip<span style="color:#e6db74">:</span><span style="color:#e6db74">x</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;0x</span><span style="color:#e6db74">{</span>i<span style="color:#f92672">.</span>address<span style="color:#e6db74">:</span><span style="color:#e6db74">x</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">{</span>i<span style="color:#f92672">.</span>mnemonic<span style="color:#e6db74">}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">{</span>i<span style="color:#f92672">.</span>op_str<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
</span></span></code></pre></div><p>This Python script parses the program.bin file, displays each code block, replaces conditional mov instructions with jmps, and displays the stack frame used before each block.</p>
<h2 id="solver">Solver</h2>
<p>Since the generated program is quite substantial, you can pass it to an LLM to understand what it does.</p>
<p>The LLM tells us that the program implements a Suguru puzzle verifier. Our input is therefore used to solve this puzzle, and displays the flag in case of success.</p>
<p>By extracting the constraints from the verifier, we can write a solver with z3 to solve the puzzle:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> z3 <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>constraints <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    [<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>],
</span></span><span style="display:flex;"><span>    [<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>],
</span></span><span style="display:flex;"><span>    [<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>],
</span></span><span style="display:flex;"><span>    [<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>],
</span></span><span style="display:flex;"><span>    [<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>],
</span></span><span style="display:flex;"><span>    [<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>],
</span></span><span style="display:flex;"><span>    [<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>],
</span></span><span style="display:flex;"><span>    [<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>],
</span></span><span style="display:flex;"><span>    [<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>],
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>areas <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    [<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">3</span>],
</span></span><span style="display:flex;"><span>    [<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">4</span>,<span style="color:#ae81ff">4</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">3</span>],
</span></span><span style="display:flex;"><span>    [<span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">4</span>,<span style="color:#ae81ff">4</span>,<span style="color:#ae81ff">6</span>,<span style="color:#ae81ff">6</span>,<span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">7</span>],
</span></span><span style="display:flex;"><span>    [<span style="color:#ae81ff">8</span>,<span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">4</span>,<span style="color:#ae81ff">9</span>,<span style="color:#ae81ff">6</span>,<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">7</span>],
</span></span><span style="display:flex;"><span>    [<span style="color:#ae81ff">8</span>,<span style="color:#ae81ff">8</span>,<span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">9</span>,<span style="color:#ae81ff">9</span>,<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">10</span>],
</span></span><span style="display:flex;"><span>    [<span style="color:#ae81ff">11</span>,<span style="color:#ae81ff">8</span>,<span style="color:#ae81ff">12</span>,<span style="color:#ae81ff">9</span>,<span style="color:#ae81ff">9</span>,<span style="color:#ae81ff">13</span>,<span style="color:#ae81ff">13</span>,<span style="color:#ae81ff">13</span>,<span style="color:#ae81ff">13</span>],
</span></span><span style="display:flex;"><span>    [<span style="color:#ae81ff">11</span>,<span style="color:#ae81ff">12</span>,<span style="color:#ae81ff">12</span>,<span style="color:#ae81ff">12</span>,<span style="color:#ae81ff">14</span>,<span style="color:#ae81ff">15</span>,<span style="color:#ae81ff">15</span>,<span style="color:#ae81ff">15</span>,<span style="color:#ae81ff">15</span>],
</span></span><span style="display:flex;"><span>    [<span style="color:#ae81ff">11</span>,<span style="color:#ae81ff">12</span>,<span style="color:#ae81ff">14</span>,<span style="color:#ae81ff">14</span>,<span style="color:#ae81ff">14</span>,<span style="color:#ae81ff">16</span>,<span style="color:#ae81ff">15</span>,<span style="color:#ae81ff">17</span>,<span style="color:#ae81ff">17</span>],
</span></span><span style="display:flex;"><span>    [<span style="color:#ae81ff">18</span>,<span style="color:#ae81ff">18</span>,<span style="color:#ae81ff">18</span>,<span style="color:#ae81ff">18</span>,<span style="color:#ae81ff">14</span>,<span style="color:#ae81ff">16</span>,<span style="color:#ae81ff">17</span>,<span style="color:#ae81ff">17</span>,<span style="color:#ae81ff">17</span>],
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>grid <span style="color:#f92672">=</span> [[BitVec(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;x</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}{</span>j<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">8</span>) <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">9</span>)] <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">9</span>)]
</span></span><span style="display:flex;"><span>s <span style="color:#f92672">=</span> Solver()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">9</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">9</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># values between 1 and 9</span>
</span></span><span style="display:flex;"><span>        s<span style="color:#f92672">.</span>add(And(grid[i][j] <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">1</span>, grid[i][j] <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">9</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># apply pre-filled values</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> constraints[i][j] <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            s<span style="color:#f92672">.</span>add(grid[i][j] <span style="color:#f92672">==</span> constraints[i][j])
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># no repetition with neighbors (Suguru)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">8</span>:
</span></span><span style="display:flex;"><span>            s<span style="color:#f92672">.</span>add(grid[i][j] <span style="color:#f92672">!=</span> grid[i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>][j])
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> j <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">8</span>:
</span></span><span style="display:flex;"><span>                s<span style="color:#f92672">.</span>add(grid[i][j] <span style="color:#f92672">!=</span> grid[i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>][j<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> j <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>                s<span style="color:#f92672">.</span>add(grid[i][j] <span style="color:#f92672">!=</span> grid[i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>][j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> i <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            s<span style="color:#f92672">.</span>add(grid[i][j] <span style="color:#f92672">!=</span> grid[i<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>][j])
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> j <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">8</span>:
</span></span><span style="display:flex;"><span>                s<span style="color:#f92672">.</span>add(grid[i][j] <span style="color:#f92672">!=</span> grid[i<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>][j<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> j <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>                s<span style="color:#f92672">.</span>add(grid[i][j] <span style="color:#f92672">!=</span> grid[i<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>][j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> j <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">8</span>:
</span></span><span style="display:flex;"><span>            s<span style="color:#f92672">.</span>add(grid[i][j] <span style="color:#f92672">!=</span> grid[i][j<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> j <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            s<span style="color:#f92672">.</span>add(grid[i][j] <span style="color:#f92672">!=</span> grid[i][j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>c_areas <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0</span>]<span style="color:#f92672">*</span><span style="color:#ae81ff">0x13</span>
</span></span><span style="display:flex;"><span>s_areas <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0</span>]<span style="color:#f92672">*</span><span style="color:#ae81ff">0x13</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">9</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">9</span>):
</span></span><span style="display:flex;"><span>        c_areas[areas[i][j]] <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        s_areas[areas[i][j]] <span style="color:#f92672">+=</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> (grid[i][j] <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0x13</span>):
</span></span><span style="display:flex;"><span>    s<span style="color:#f92672">.</span>add(s_areas[i] <span style="color:#f92672">==</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> c_areas[i]) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> s<span style="color:#f92672">.</span>check() <span style="color:#f92672">==</span> sat:
</span></span><span style="display:flex;"><span>    m <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>model()
</span></span><span style="display:flex;"><span>    sol_mat <span style="color:#f92672">=</span> [[m[grid[i][j]]<span style="color:#f92672">.</span>as_long() <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">9</span>)] <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">9</span>)]
</span></span><span style="display:flex;"><span>    sol <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(str(m[grid[i][j]]<span style="color:#f92672">.</span>as_long()) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">9</span>) <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">9</span>))
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Solution:&#34;</span>, sol)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;[-] Unable to solve the puzzle&#34;</span>)
</span></span></code></pre></div><p>Running the solver, we find that the correct input is: <code>141253514235414232142323541235141232142323541231514132142323251351541434143232521</code></p>
<p>Let&rsquo;s verify:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>l0key at dev in <span style="color:#f92672">[</span>~/Documents/hackropole/pors<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>20:56:17 › ./pors
</span></span><span style="display:flex;"><span>Enter your input: <span style="color:#ae81ff">141253514235414232142323541235141232142323541231514132142323251351541434143232521</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Congratulations! You can validate the challenge with this flag: CWTE<span style="color:#f92672">{</span>pr0gr4mm4t10n_0r13nt33_r3t0ur_s1gn4l<span style="color:#f92672">}</span>
</span></span></code></pre></div><p>Thanks to spikeroot for this awesome challenge!</p>
<p>References:
<a href="https://man7.org/linux/man-pages/man7/signal.7.html">https://man7.org/linux/man-pages/man7/signal.7.html</a>
<a href="https://sthbrx.github.io/blog/2016/05/13/srop-mitigation/">https://sthbrx.github.io/blog/2016/05/13/srop-mitigation/</a>
<a href="https://www.cs.vu.nl/~herbertb/papers/srop_sp14.pdf">https://www.cs.vu.nl/~herbertb/papers/srop_sp14.pdf</a></p>

            </div>

            
            

            
            <nav class="post-navigation">
                
                <div class="nav-previous">
                    <span class="nav-label">← Previous</span>
                    <a href="http://localhost:1313/posts/baby/vulnlab_baby/" class="nav-title">Vulnlab : Baby Easy</a>
                </div>
                

                
                <div></div>
                
            </nav>
        </article>

        <aside class="sidebar">
            <nav class="toc">
                <h4>Contents</h4>
                <div id="toc-content">
                    
                </div>
            </nav>
        </aside>
        </div>
    </div>
</div>

    </main>

    

    <script src="http://localhost:1313/js/main.js"></script>
</body>
</html>
